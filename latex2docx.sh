#!/bin/bash
# ========================================
# –°–ö–†–ò–ü–¢ –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò LaTeX ‚Üí DOCX
# ========================================
# –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç LaTeX —Ñ–∞–π–ª—ã –≤ DOCX —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∂—É—Ä–Ω–∞–ª–∞ "–í–µ—Å—Ç–Ω–∏–∫ –ú–ì–£. –°–µ—Ä–∏—è 13. –í–æ—Å—Ç–æ–∫–æ–≤–µ–¥–µ–Ω–∏–µ"
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./latex2docx.sh article.tex
#   ./latex2docx.sh article.tex output.docx

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# ========================================
# –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# ========================================

if ! command -v pandoc &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: pandoc –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pandoc: brew install pandoc (macOS) –∏–ª–∏ apt-get install pandoc (Linux)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ pandoc
PANDOC_VERSION=$(pandoc --version | head -n1 | awk '{print $2}')
echo "‚ÑπÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è pandoc –≤–µ—Ä—Å–∏–∏ $PANDOC_VERSION"

# ========================================
# –ü–ê–†–ê–ú–ï–¢–†–´
# ========================================

INPUT_FILE="$1"
OUTPUT_FILE="${2:-${INPUT_FILE%.tex}.docx}"
REFERENCE_DOCX="reference-vestnik.docx"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
if [ -z "$INPUT_FILE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –≤—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <input.tex> [output.docx]"
    exit 1
fi

if [ ! -f "$INPUT_FILE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª '$INPUT_FILE' –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "üìÑ –í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: $INPUT_FILE"
echo "üìù –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: $OUTPUT_FILE"

# ========================================
# –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê
# ========================================

echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –æ—á–∏—â–µ–Ω–Ω—ã–º LaTeX
TEMP_FILE=$(mktemp /tmp/latex2docx.XXXXXX.tex)

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, —É–±–∏—Ä–∞—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è LaTeX –∫–æ–º–∞–Ω–¥—ã
# –∫–æ—Ç–æ—Ä—ã–µ pandoc –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç
# –¢–∞–∫–∂–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
sed -e 's/‚Äî/---/g' \
    -e 's/‚Äì/--/g' \
    -e 's/\\usepackage{vestnik}//' \
    -e 's/\\udc{[^}]*}//' \
    -e 's/\\articletitleru{\([^}]*\)}/\\section*{\U\1}/' \
    -e 's/\\articletitleen{\([^}]*\)}/\\section*{\U\1}/' \
    -e 's/\\authorru{\([^}]*\)}/\\textbf{\1}\\newline/' \
    -e 's/\\authoren{\([^}]*\)}/\\textbf{\1}\\newline/' \
    -e 's/\\institution{\([^}]*\)}/\\textit{\1}\\newline/' \
    -e 's/\\institutionen{\([^}]*\)}/\\textit{\1}\\newline/' \
    -e 's/\\abstractru{\([^}]*\)}/\\textbf{\\textit{–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:}} \\textit{\1}\\par/' \
    -e 's/\\abstracten{\([^}]*\)}/\\textbf{\\textit{Abstract:}} \\textit{\1}\\par/' \
    -e 's/\\keywordsru{\([^}]*\)}/\\textbf{\\textit{–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:}} \\textit{\1}\\par/' \
    -e 's/\\keywordsen{\([^}]*\)}/\\textbf{\\textit{Key words:}} \\textit{\1}\\par/' \
    -e 's/\\funding{\([^}]*\)}/\\textbf{–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ:} \1\\par/' \
    -e 's/\\fundingen{\([^}]*\)}/\\textbf{Funding:} \1\\par/' \
    -e 's/\\forcitation{\([^}]*\)}/\\textbf{–î–ª—è —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:} \1\\par/' \
    -e 's/\\forcitationen{\([^}]*\)}/\\textbf{For citation:} \1\\par/' \
    -e 's/\\aboutauthor{\([^}]*\)}/\\paragraph{About the author:} \1/' \
    -e 's/\\bibliographyru/\\section*{–°–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã}/' \
    -e 's/\\referencesen/\\section*{References}/' \
    -e 's/\\bibliosectioncyrillic/\\subsection*{–ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)}/' \
    -e 's/\\bibliosectionlatin/\\subsection*{–ù–∞ –∑–∞–ø–∞–¥–Ω—ã—Ö —è–∑—ã–∫–∞—Ö (–ª–∞—Ç–∏–Ω–∏—Ü–∞)}/' \
    -e 's/\\bibliosectionoriental/\\subsection*{–ù–∞ –≤–æ—Å—Ç–æ—á–Ω—ã—Ö —è–∑—ã–∫–∞—Ö (–∏–µ—Ä–æ–≥–ª–∏—Ñ–∏–∫–∞)}/' \
    -e 's/\\begin{bibliolist}/\\begin{itemize}/' \
    -e 's/\\end{bibliolist}/\\end{itemize}/' \
    -e 's/\\begin{bibliolistnum}/\\begin{enumerate}/' \
    -e 's/\\end{bibliolistnum}/\\end{enumerate}/' \
    "$INPUT_FILE" > "$TEMP_FILE"

echo "‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# ========================================
# –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –° PANDOC
# ========================================

echo "üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ DOCX..."

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã pandoc –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∂—É—Ä–Ω–∞–ª–∞
PANDOC_OPTS=(
    --from=latex
    --to=docx
    --standalone
    --number-sections
    --toc=false
)

# –ï—Å–ª–∏ –µ—Å—Ç—å reference.docx, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è —Å—Ç–∏–ª–µ–π
if [ -f "$REFERENCE_DOCX" ]; then
    echo "‚ÑπÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª —Å—Ç–∏–ª–µ–π: $REFERENCE_DOCX"
    PANDOC_OPTS+=(--reference-doc="$REFERENCE_DOCX")
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–∞–π–ª —Å—Ç–∏–ª–µ–π '$REFERENCE_DOCX' –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "   –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ pandoc"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ './create-reference-docx.sh' –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ —Å—Ç–∏–ª–µ–π"
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
pandoc "${PANDOC_OPTS[@]}" "$TEMP_FILE" -o "$OUTPUT_FILE"

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm "$TEMP_FILE"

echo "‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"

# ========================================
# –ü–û–°–¢–û–ë–†–ê–ë–û–¢–ö–ê –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
# ========================================

echo ""
echo "üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –≤ Word:"
echo ""
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª: $OUTPUT_FILE"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"
echo "   ‚Ä¢ –®—Ä–∏—Ñ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: Times New Roman 12pt, –∏–Ω—Ç–µ—Ä–≤–∞–ª 1.5"
echo "   ‚Ä¢ –®—Ä–∏—Ñ—Ç —Å–Ω–æ—Å–æ–∫: Times New Roman 10pt, –∏–Ω—Ç–µ—Ä–≤–∞–ª 1.0"
echo "   ‚Ä¢ –ê–±–∑–∞—Ü–Ω—ã–π –æ—Ç—Å—Ç—É–ø: 1.25 —Å–º"
echo "   ‚Ä¢ –ü–æ–ª—è: 2.54 —Å–º (1 –¥—é–π–º) —Å–æ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω—É–º–µ—Ä–∞—Ü–∏—é —Å—Ç—Ä–∞–Ω–∏—Ü"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–Ω–æ—Å–æ–∫ –∏ —Å–ø–∏—Å–∫–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å"
echo "   —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –≤ Microsoft Word."
echo ""
echo "‚ú® –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: $OUTPUT_FILE"
